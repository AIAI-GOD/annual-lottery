<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´ä¼šæŠ½å¥–å°å·¥å…· | è‡ªå®šä¹‰ç‰ˆ</title>
    <!-- å¼•å…¥Tailwind CSSç®€åŒ–æ ·å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* æ»šåŠ¨åŠ¨ç”»æ ¸å¿ƒæ ·å¼ */
        .roll-animation {
            transition: all 0.1s linear;
        }
        /* ä¸­å¥–ç»“æœé«˜äº® */
        .winner-highlight {
            animation: highlight 1s ease-in-out infinite alternate;
        }
        @keyframes highlight {
            from { transform: scale(1); }
            to { transform: scale(1.05); box-shadow: 0 0 20px #fbbf24; }
        }
        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">å¹´ä¼šæŠ½å¥–å°å·¥å…·</h1>
            <p class="text-gray-500">è‡ªå®šä¹‰å¥–é¡¹ | æ‰«ç å‚ä¸ | æ»šåŠ¨æŠ½å¥–</p>
        </div>

        <!-- æ ¸å¿ƒåŠŸèƒ½åŒºï¼šåˆ†å·¦å³å¸ƒå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šæŠ½å¥–é…ç½® + æ“ä½œåŒº -->
            <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6">
                <!-- 1. æŠ½å¥–æ± ç®¡ç† -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-users mr-2 text-blue-500"></i> æŠ½å¥–æ± ç®¡ç†
                    </h2>
                    
                    <!-- æ‰«ç æ·»åŠ å‚ä¸è€…æç¤º -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-gray-700 mb-2">å‚ä¸è€…æ‰«ç æ·»åŠ ï¼š</p>
                        <div class="flex justify-center">
                            <!-- ğŸ”¥ ä¿®å¤åçš„imgæ ‡ç­¾ï¼ˆå…³é”®ä¿®æ”¹å¤„ï¼‰ -->
                            <div class="bg-white p-2 rounded shadow">
                                <img src="https://raw.githubusercontent.com/AIAI-GOD/annual-lottery/refs/heads/main/QRcode" alt="æ‰«ç å‚ä¸æŠ½å¥–" class="w-48 h-48">
                                <p class="text-xs text-center mt-1 text-gray-500">æ‰«ç åŠ å…¥æŠ½å¥–æ± </p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 text-center mt-2">æç¤ºï¼šéœ€å°†æ­¤é¡µé¢éƒ¨ç½²åˆ°å…¬ç½‘ï¼Œç”ŸæˆæŒ‡å‘ ?add=1 çš„äºŒç»´ç </p>
                    </div>

                    <!-- æŠ½å¥–æ± ç»Ÿè®¡ -->
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-600">å½“å‰æŠ½å¥–æ± äººæ•°ï¼š</span>
                        <span id="pool-count" class="text-xl font-bold text-blue-500">0</span>
                    </div>

                    <!-- æ¸…ç©ºæŠ½å¥–æ± æŒ‰é’® -->
                    <button id="clear-pool" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition-colors">
                        <i class="fa fa-trash mr-1"></i> æ¸…ç©ºæŠ½å¥–æ± 
                    </button>
                </div>

                <!-- 2. å¥–é¡¹é…ç½® -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-trophy mr-2 text-yellow-500"></i> å¥–é¡¹é…ç½®
                    </h2>

                    <!-- å¥–é¡¹äººæ•°é…ç½® -->
                    <div class="space-y-3 mb-4">
                        <div class="flex items-center justify-between">
                            <label class="text-gray-700">ç‰¹ç­‰å¥–äººæ•°ï¼š</label>
                            <input type="number" id="special-count" class="w-16 px-2 py-1 border rounded" value="1" min="1">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-gray-700">ä¸€ç­‰å¥–äººæ•°ï¼š</label>
                            <input type="number" id="first-count" class="w-16 px-2 py-1 border rounded" value="2" min="1">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-gray-700">äºŒç­‰å¥–äººæ•°ï¼š</label>
                            <input type="number" id="second-count" class="w-16 px-2 py-1 border rounded" value="5" min="1">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-gray-700">ä¸‰ç­‰å¥–äººæ•°ï¼š</label>
                            <input type="number" id="third-count" class="w-16 px-2 py-1 border rounded" value="10" min="1">
                        </div>
                    </div>

                    <!-- æŠ½å¥–æ¨¡å¼é€‰æ‹© -->
                    <div class="mb-4">
                        <label class="text-gray-700 block mb-2">æŠ½å¥–æ¨¡å¼ï¼š</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="draw-mode" value="unique" checked class="mr-1">
                                <span>ä¸é‡å¤æŠ½å¥–ï¼ˆä¸­å¥–åç§»å‡ºï¼‰</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="draw-mode" value="repeat" class="mr-1">
                                <span>é‡å¤æŠ½å¥–ï¼ˆä¸­å¥–åä¿ç•™ï¼‰</span>
                            </label>
                        </div>
                    </div>

                    <!-- é€‰æ‹©å½“å‰å¥–é¡¹ -->
                    <div class="mb-4">
                        <label class="text-gray-700 block mb-2">å½“å‰æŠ½å¥–å¥–é¡¹ï¼š</label>
                        <select id="current-award" class="w-full px-3 py-2 border rounded">
                            <option value="special">ç‰¹ç­‰å¥–</option>
                            <option value="first">ä¸€ç­‰å¥–</option>
                            <option value="second">äºŒç­‰å¥–</option>
                            <option value="third">ä¸‰ç­‰å¥–</option>
                        </select>
                    </div>
                </div>

                <!-- 3. æŠ½å¥–æ“ä½œ -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-play-circle mr-2 text-green-500"></i> æŠ½å¥–æ“ä½œ
                    </h2>

                    <div class="flex gap-3">
                        <button id="start-draw" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg transition-colors text-lg">
                            <i class="fa fa-play mr-1"></i> å¼€å§‹æŠ½å¥–
                        </button>
                        <button id="stop-draw" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg transition-colors text-lg disabled:opacity-50" disabled>
                            <i class="fa fa-pause mr-1"></i> åœæ­¢æŠ½å¥–
                        </button>
                    </div>

                    <!-- é‡ç½®ä¸­å¥–è®°å½• -->
                    <button id="reset-winners" class="w-full mt-3 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded-lg transition-colors">
                        <i class="fa fa-refresh mr-1"></i> é‡ç½®æ‰€æœ‰ä¸­å¥–è®°å½•
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæŠ½å¥–å±•ç¤º + ä¸­å¥–è®°å½• -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 1. æŠ½å¥–æ»šåŠ¨å±•ç¤ºåŒº -->
                <div class="bg-white rounded-xl shadow-md p-6 h-96 flex flex-col">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">
                        <span id="award-title">ç‰¹ç­‰å¥–æŠ½å¥–</span>
                    </h2>

                    <!-- æ»šåŠ¨å±•ç¤ºå®¹å™¨ -->
                    <div id="draw-container" class="flex-1 flex flex-wrap justify-center items-center gap-4 overflow-auto">
                        <!-- åˆå§‹æç¤º -->
                        <div class="text-gray-400 text-center">
                            <i class="fa fa-info-circle text-4xl mb-2"></i>
                            <p>ç‚¹å‡»ã€Œå¼€å§‹æŠ½å¥–ã€å¼€å§‹æ»šåŠ¨</p>
                            <p class="text-xs mt-1">æŠ½å¥–æ± ä¸ºç©ºæ—¶æ— æ³•å¼€å§‹</p>
                        </div>
                    </div>
                </div>

                <!-- 2. ä¸­å¥–è®°å½•å±•ç¤º -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-list mr-2 text-purple-500"></i> ä¸­å¥–è®°å½•
                    </h2>

                    <!-- åˆ†å¥–é¡¹å±•ç¤º -->
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">ç‰¹ç­‰å¥–</h3>
                            <div id="special-winners" class="flex flex-wrap gap-3 min-h-[60px]">
                                <span class="text-gray-400 text-sm">æš‚æ— ä¸­å¥–è®°å½•</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">ä¸€ç­‰å¥–</h3>
                            <div id="first-winners" class="flex flex-wrap gap-3 min-h-[60px]">
                                <span class="text-gray-400 text-sm">æš‚æ— ä¸­å¥–è®°å½•</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">äºŒç­‰å¥–</h3>
                            <div id="second-winners" class="flex flex-wrap gap-3 min-h-[60px]">
                                <span class="text-gray-400 text-sm">æš‚æ— ä¸­å¥–è®°å½•</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">ä¸‰ç­‰å¥–</h3>
                            <div id="third-winners" class="flex flex-wrap gap-3 min-h-[60px]">
                                <span class="text-gray-400 text-sm">æš‚æ— ä¸­å¥–è®°å½•</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‚ä¸è€…æ·»åŠ å¼¹çª—ï¼ˆæ‰«ç åæ˜¾ç¤ºï¼‰ -->
    <div id="add-participant-modal" class="fixed inset-0 bg-black/50 flex justify-center items-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">åŠ å…¥å¹´ä¼šæŠ½å¥–æ± </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">æ˜µç§°ï¼š</label>
                    <input type="text" id="participant-name" class="w-full px-3 py-2 border rounded" placeholder="è¯·è¾“å…¥ä½ çš„å¾®ä¿¡æ˜µç§°">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">å¤´åƒï¼š</label>
                    <input type="file" id="participant-avatar" accept="image/*" class="w-full">
                </div>
                <button id="submit-participant" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition-colors">
                    ç¡®è®¤åŠ å…¥æŠ½å¥–æ± 
                </button>
                <button id="close-modal" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-lg transition-colors mt-2">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <script>
    // æ ¸å¿ƒæ•°æ®å­˜å‚¨ï¼ˆlocalStorageï¼‰
    const STORAGE_KEYS = {
        pool: 'lottery_pool',       // æŠ½å¥–æ± 
        winners: 'lottery_winners'  // ä¸­å¥–è®°å½•
    };

    // åˆå§‹åŒ–æ•°æ®
    let lotteryPool = JSON.parse(localStorage.getItem(STORAGE_KEYS.pool)) || [];
    let winners = JSON.parse(localStorage.getItem(STORAGE_KEYS.winners)) || {
        special: [],
        first: [],
        second: [],
        third: []
    };
    let isDrawing = false;  // æ˜¯å¦æ­£åœ¨æŠ½å¥–
    let drawInterval = null; // æŠ½å¥–æ»šåŠ¨å®šæ—¶å™¨

    // DOMå…ƒç´ 
    const elements = {
        poolCount: document.getElementById('pool-count'),
        clearPool: document.getElementById('clear-pool'),
        startDraw: document.getElementById('start-draw'),
        stopDraw: document.getElementById('stop-draw'),
        resetWinners: document.getElementById('reset-winners'),
        drawContainer: document.getElementById('draw-container'),
        awardTitle: document.getElementById('award-title'),
        currentAward: document.getElementById('current-award'),
        addModal: document.getElementById('add-participant-modal'),
        submitParticipant: document.getElementById('submit-participant'),
        closeModal: document.getElementById('close-modal'),
        participantName: document.getElementById('participant-name'),
        participantAvatar: document.getElementById('participant-avatar'),
        // å¥–é¡¹äººæ•°é…ç½®
        specialCount: document.getElementById('special-count'),
        firstCount: document.getElementById('first-count'),
        secondCount: document.getElementById('second-count'),
        thirdCount: document.getElementById('third-count'),
        // ä¸­å¥–è®°å½•å®¹å™¨
        specialWinners: document.getElementById('special-winners'),
        firstWinners: document.getElementById('first-winners'),
        secondWinners: document.getElementById('second-winners'),
        thirdWinners: document.getElementById('third-winners')
    };

    // åˆå§‹åŒ–é¡µé¢ï¼ˆä¿®å¤ï¼šç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œï¼‰
    function initPage() {
        // æ›´æ–°æŠ½å¥–æ± äººæ•°
        updatePoolCount();
        // æ¸²æŸ“ä¸­å¥–è®°å½•
        renderWinners();
        // ç»‘å®šäº‹ä»¶
        bindEvents();
        
        // ä¿®å¤ï¼šå»¶è¿Ÿæ‰§è¡Œå‚æ•°æ£€æŸ¥ï¼Œå…¼å®¹å¾®ä¿¡æµè§ˆå™¨
        setTimeout(checkAddParticipant, 500);
    }

    // æ›´æ–°æŠ½å¥–æ± äººæ•°æ˜¾ç¤º
    function updatePoolCount() {
        elements.poolCount.textContent = lotteryPool.length;
        localStorage.setItem(STORAGE_KEYS.pool, JSON.stringify(lotteryPool));
    }

    // æ¸²æŸ“ä¸­å¥–è®°å½•
    function renderWinners() {
        // æ¸²æŸ“å„å¥–é¡¹ä¸­å¥–è®°å½•
        renderAwardWinners('special', elements.specialWinners);
        renderAwardWinners('first', elements.firstWinners);
        renderAwardWinners('second', elements.secondWinners);
        renderAwardWinners('third', elements.thirdWinners);
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem(STORAGE_KEYS.winners, JSON.stringify(winners));
    }

    // æ¸²æŸ“å•ä¸ªå¥–é¡¹çš„ä¸­å¥–è®°å½•
    function renderAwardWinners(awardKey, container) {
        const awardWinners = winners[awardKey];
        if (awardWinners.length === 0) {
            container.innerHTML = '<span class="text-gray-400 text-sm">æš‚æ— ä¸­å¥–è®°å½•</span>';
            return;
        }
        container.innerHTML = awardWinners.map(user => `
            <div class="flex flex-col items-center p-2 border rounded-lg winner-highlight">
                <img src="${user.avatar || 'https://picsum.photos/60/60'}" alt="${user.name}" class="w-12 h-12 rounded-full object-cover">
                <span class="text-sm mt-1">${user.name}</span>
            </div>
        `).join('');
    }

    // ä¿®å¤ï¼šå¢å¼ºç‰ˆå‚æ•°æ£€æŸ¥ï¼ˆå…¼å®¹å¾®ä¿¡æµè§ˆå™¨ï¼‰
    function checkAddParticipant() {
        // æ–¹æ¡ˆ1ï¼šè§£æURLå‚æ•°ï¼ˆä¸»é€»è¾‘ï¼‰
        const params = new URLSearchParams(window.location.search);
        // æ–¹æ¡ˆ2ï¼šå…œåº•æ£€æŸ¥ï¼ˆé˜²æ­¢å‚æ•°è§£æå¤±è´¥ï¼‰
        const urlHasAddParam = window.location.href.includes('?add=1') || window.location.href.includes('&add=1');
        
        // åªè¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼Œå°±å¼¹å‡ºå¼¹çª—
        if (params.get('add') === '1' || urlHasAddParam) {
            // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—ï¼ˆç§»é™¤hiddenç±»ï¼‰
            elements.addModal.classList.remove('hidden');
            // ä¿®å¤ï¼šå¾®ä¿¡æµè§ˆå™¨å¯èƒ½é®æŒ¡å¼¹çª—ï¼Œå¼ºåˆ¶ç½®é¡¶
            elements.addModal.style.zIndex = '9999';
            elements.addModal.style.display = 'flex';
        }
    }

    // ç»‘å®šæ‰€æœ‰äº‹ä»¶
    function bindEvents() {
        // æ¸…ç©ºæŠ½å¥–æ± 
        elements.clearPool.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæŠ½å¥–æ± å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                lotteryPool = [];
                updatePoolCount();
                alert('æŠ½å¥–æ± å·²æ¸…ç©º');
            }
        });

        // å¼€å§‹æŠ½å¥–
        elements.startDraw.addEventListener('click', startDrawing);

        // åœæ­¢æŠ½å¥–
        elements.stopDraw.addEventListener('click', stopDrawing);

        // é‡ç½®ä¸­å¥–è®°å½•
        elements.resetWinners.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä¸­å¥–è®°å½•å—ï¼Ÿ')) {
                winners = { special: [], first: [], second: [], third: [] };
                renderWinners();
                alert('ä¸­å¥–è®°å½•å·²é‡ç½®');
            }
        });

        // æäº¤å‚ä¸è€…
        elements.submitParticipant.addEventListener('click', addParticipant);

        // å…³é—­å¼¹çª—
        elements.closeModal.addEventListener('click', () => {
            elements.addModal.classList.add('hidden');
            elements.participantName.value = '';
            elements.participantAvatar.value = '';
        });

        // åˆ‡æ¢å½“å‰å¥–é¡¹
        elements.currentAward.addEventListener('change', () => {
            const awardMap = {
                special: 'ç‰¹ç­‰å¥–',
                first: 'ä¸€ç­‰å¥–',
                second: 'äºŒç­‰å¥–',
                third: 'ä¸‰ç­‰å¥–'
            };
            elements.awardTitle.textContent = `${awardMap[elements.currentAward.value]}æŠ½å¥–`;
        });
    }

    // æ·»åŠ å‚ä¸è€…
    function addParticipant() {
        const name = elements.participantName.value.trim();
        const avatarFile = elements.participantAvatar.files[0];
        
        if (!name) {
            alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°');
            return;
        }

        // å¤„ç†å¤´åƒï¼ˆè½¬Base64ï¼‰
        const reader = new FileReader();
        reader.onload = function(e) {
            const newParticipant = {
                id: Date.now(), // å”¯ä¸€ID
                name: name,
                avatar: avatarFile ? e.target.result : 'https://picsum.photos/60/60' // é»˜è®¤å¤´åƒ
            };

            // æ·»åŠ åˆ°æŠ½å¥–æ± 
            lotteryPool.push(newParticipant);
            updatePoolCount();

            // å…³é—­å¼¹çª—
            elements.addModal.classList.add('hidden');
            elements.participantName.value = '';
            elements.participantAvatar.value = '';

            alert('æˆåŠŸåŠ å…¥æŠ½å¥–æ± ï¼');
        };

        if (avatarFile) {
            reader.readAsDataURL(avatarFile);
        } else {
            // æ— å¤´åƒæ—¶ç›´æ¥æ·»åŠ 
            const newParticipant = {
                id: Date.now(),
                name: name,
                avatar: 'https://picsum.photos/60/60'
            };
            lotteryPool.push(newParticipant);
            updatePoolCount();
            elements.addModal.classList.add('hidden');
            elements.participantName.value = '';
            alert('æˆåŠŸåŠ å…¥æŠ½å¥–æ± ï¼');
        }
    }

    // å¼€å§‹æŠ½å¥–
    function startDrawing() {
        // æ£€æŸ¥æŠ½å¥–æ± æ˜¯å¦ä¸ºç©º
        if (lotteryPool.length === 0) {
            alert('æŠ½å¥–æ± ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å‚ä¸è€…ï¼');
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æœªä¸­å¥–äººæ•°ï¼ˆä¸é‡å¤æŠ½å¥–æ—¶ï¼‰
        const drawMode = document.querySelector('input[name="draw-mode"]:checked').value;
        const currentAwardKey = elements.currentAward.value;
        const awardCount = parseInt(document.getElementById(`${currentAwardKey}-count`).value);
        
        if (drawMode === 'unique') {
            // è¿‡æ»¤å·²ä¸­å¥–ç”¨æˆ·
            const allWinners = [...winners.special, ...winners.first, ...winners.second, ...winners.third];
            const availableUsers = lotteryPool.filter(user => !allWinners.some(w => w.id === user.id));
            
            if (availableUsers.length < awardCount) {
                alert(`å‰©ä½™å¯æŠ½å¥–äººæ•°ä¸è¶³ï¼ˆä»…${availableUsers.length}äººï¼‰ï¼Œæ— æ³•æŠ½å–${awardCount}äººï¼`);
                return;
            }
        }

        // è®¾ç½®æŠ½å¥–çŠ¶æ€
        isDrawing = true;
        elements.startDraw.disabled = true;
        elements.stopDraw.disabled = false;

        // å¼€å§‹æ»šåŠ¨åŠ¨ç”»
        drawInterval = setInterval(() => {
            renderDrawContainer(currentAwardKey, awardCount);
        }, 100);
    }

    // åœæ­¢æŠ½å¥–
    function stopDrawing() {
        // æ¸…é™¤å®šæ—¶å™¨
        clearInterval(drawInterval);
        isDrawing = false;
        elements.startDraw.disabled = false;
        elements.stopDraw.disabled = true;

        // ç¡®å®šä¸­å¥–ç”¨æˆ·
        const currentAwardKey = elements.currentAward.value;
        const awardCount = parseInt(document.getElementById(`${currentAwardKey}-count`).value);
        const drawMode = document.querySelector('input[name="draw-mode"]:checked').value;

        // ç­›é€‰å¯ä¸­å¥–ç”¨æˆ·
        let availableUsers = [...lotteryPool];
        if (drawMode === 'unique') {
            // æ’é™¤å·²ä¸­å¥–ç”¨æˆ·
            const allWinners = [...winners.special, ...winners.first, ...winners.second, ...winners.third];
            availableUsers = availableUsers.filter(user => !allWinners.some(w => w.id === user.id));
        }

        // éšæœºæŠ½å–ä¸­å¥–ç”¨æˆ·
        const selectedWinners = [];
        const shuffledUsers = [...availableUsers].sort(() => Math.random() - 0.5); // æ‰“ä¹±æ•°ç»„
        for (let i = 0; i < awardCount && i < shuffledUsers.length; i++) {
            selectedWinners.push(shuffledUsers[i]);
        }

        // æ·»åŠ åˆ°ä¸­å¥–è®°å½•
        winners[currentAwardKey] = [...winners[currentAwardKey], ...selectedWinners];
        
        // å¦‚æœæ˜¯ä¸é‡å¤æŠ½å¥–ï¼Œä»æŠ½å¥–æ± ç§»é™¤ï¼ˆå¯é€‰ï¼šä¹Ÿå¯ä¿ç•™ï¼Œä»…æ ‡è®°å·²ä¸­å¥–ï¼‰
        if (drawMode === 'unique') {
            lotteryPool = lotteryPool.filter(user => !selectedWinners.some(w => w.id === user.id));
            updatePoolCount();
        }

        // æ¸²æŸ“ä¸­å¥–ç»“æœ
        renderDrawContainer(currentAwardKey, awardCount, selectedWinners);
        // æ›´æ–°ä¸­å¥–è®°å½•
        renderWinners();

        // æç¤º
        const awardNameMap = {
            special: 'ç‰¹ç­‰å¥–',
            first: 'ä¸€ç­‰å¥–',
            second: 'äºŒç­‰å¥–',
            third: 'ä¸‰ç­‰å¥–'
        };
        alert(`${awardNameMap[currentAwardKey]}ä¸­å¥–åå•ï¼š\n${selectedWinners.map(u => u.name).join(', ')}`);
    }

    // æ¸²æŸ“æŠ½å¥–æ»šåŠ¨å®¹å™¨
    function renderDrawContainer(awardKey, count, fixedUsers = null) {
        const awardCount = count;
        let displayUsers = [];

        if (fixedUsers) {
            // æ˜¾ç¤ºå›ºå®šä¸­å¥–ç”¨æˆ·ï¼ˆåœæ­¢åï¼‰
            displayUsers = fixedUsers;
        } else {
            // éšæœºé€‰æ‹©ç”¨æˆ·ï¼ˆæ»šåŠ¨ä¸­ï¼‰
            const drawMode = document.querySelector('input[name="draw-mode"]:checked').value;
            let availableUsers = [...lotteryPool];
            
            if (drawMode === 'unique') {
                const allWinners = [...winners.special, ...winners.first, ...winners.second, ...winners.third];
                availableUsers = availableUsers.filter(user => !allWinners.some(w => w.id === user.id));
            }

            // éšæœºé€‰æ‹©
            displayUsers = [...availableUsers].sort(() => Math.random() - 0.5).slice(0, awardCount);
        }

        // æ¸²æŸ“åˆ°å®¹å™¨
        elements.drawContainer.innerHTML = displayUsers.map(user => `
            <div class="flex flex-col items-center p-3 border rounded-lg ${fixedUsers ? 'winner-highlight' : 'roll-animation'}">
                <img src="${user.avatar}" alt="${user.name}" class="w-16 h-16 rounded-full object-cover mb-1">
                <span class="text-sm font-medium">${user.name}</span>
            </div>
        `).join('');

        // å¦‚æœæ²¡æœ‰ç”¨æˆ·
        if (displayUsers.length === 0) {
            elements.drawContainer.innerHTML = `
                <div class="text-gray-400 text-center">
                    <i class="fa fa-info-circle text-4xl mb-2"></i>
                    <p>æš‚æ— å¯æŠ½å¥–ç”¨æˆ·</p>
                </div>
            `;
        }
    }

    // ä¿®å¤ï¼šç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–ï¼ˆå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
        initPage();
    });
</script>
</body>
</html>
